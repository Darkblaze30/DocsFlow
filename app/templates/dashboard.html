<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Dashboard</title>
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">
        <link rel="stylesheet" href="../styles/dashboardCSS.css">
    </head>
    <body>
        <div class="box">
            <h1 id="welcomeMsg">Bienvenido, <span id="userName">{{ user.name if user else 'Cargando...' }}</span> 🌟</h1>
            <div class="user-info">
                <p><strong>Correo:</strong> <span id="userEmail">{{ user.email if user else '...' }}</span></p>
                <p><strong>Rol:</strong> 
                    <span class="role-badge role-{{ user.rol if user else 'user' }}" id="userRoleSpan">
                        <span id="userRoleText">{{ (user.rol|upper) if user else '...' }}</span>
                    </span>
                </p>
            </div>
            <div class="actions">
                <a href="#" onclick="logout()" id="logout-btn">Cerrar sesión</a>
            </div>

            <div id="adminPanel" class="{% if user and user.rol == 'admin' %}admin-visible{% else %}admin-hidden{% endif %}">
                <h3>🔧 Panel de Administrador</h3>
                <div class="actions">
                    <a href="/register">👤 Registrar Usuarios</a>
                    <a href="/users">📋 Ver Todos los Usuarios</a>
                    <a href="/departments">🏢 Gestionar Departamentos</a>
                </div>
            </div>
        </div>

        <div id="inactivityModal" class="inactivity-modal" style="display: none;">
            <div class="inactivity-content">
                <h2>⏰ Sesión por Expirar</h2>
                <p>Has estado inactivo por mucho tiempo.</p>
                <p>Tu sesión expirará en:</p>
                <div id="countdown" class="countdown">02:00</div>
                <p><small>¿Deseas continuar trabajando?</small></p>
                <div class="modal-buttons">
                    <button class="btn-extend" onclick="extendSession()">Continuar Sesión</button>
                    <button class="btn-logout" onclick="performLogout()">Cerrar Sesión</button>
                </div>
            </div>
        </div>
 
        <script>
            let isLoggingOut = false;
            let inactivityTimer;
            let warningTimer;
            let countdownTimer;
            let countdownSeconds = 120;
            
            const INACTIVITY_TIME = 28 * 60 * 1000;
            const WARNING_TIME = 2 * 60 * 1000;
            const TOTAL_SESSION_TIME = 30 * 60 * 1000;

            const activityEvents = [
                'mousedown', 'mousemove', 'keypress', 'scroll', 
                'touchstart', 'click', 'keydown'
            ];

            function checkAuthentication() {
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    return false;
                }
                
                const parts = token.split('.');
                if (parts.length !== 3) {
                    return false;
                }
                
                return true;
            }

            function makeAuthenticatedRequest(url, options = {}) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    return Promise.reject('No token');
                }
                
                const authOptions = {
                    ...options,
                    headers: {
                        ...options.headers,
                        'Authorization': `Bearer ${token}`
                    }
                };
                
                return fetch(url, authOptions).then(response => {
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        setTimeout(() => {
                            window.location.replace('/login');
                        }, 3000);
                        throw new Error('Unauthorized');
                    }
                    return response;
                });
            }

            function updateUserInfo(userData) {
                if (userData && userData.user) {
                    const user = userData.user;
                    
                    const userNameElement = document.getElementById('userName');
                    if (userNameElement) {
                        userNameElement.textContent = user.name || 'Sin nombre';
                    }
                    
                    const userEmailElement = document.getElementById('userEmail');
                    if (userEmailElement) {
                        userEmailElement.textContent = user.email || 'Sin email';
                    }
                    
                    const roleTextElement = document.getElementById('userRoleText');
                    const roleSpanElement = document.getElementById('userRoleSpan');
                    if (roleTextElement && roleSpanElement) {
                        roleTextElement.textContent = (user.rol || 'user').toUpperCase();
                        roleSpanElement.className = `role-badge role-${user.rol || 'user'}`;
                    }
                    const adminPanel = document.getElementById('adminPanel');
                    if (adminPanel) {
                        if (user.rol === 'admin') {
                            adminPanel.style.display = 'block';
                        } else {
                            adminPanel.style.display = 'none';
                        }
                    }
                }
            }

            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                clearTimeout(warningTimer);
                clearInterval(countdownTimer);
                
                document.getElementById('inactivityModal').style.display = 'none';
                countdownSeconds = 120;
                
                inactivityTimer = setTimeout(() => {
                    showInactivityWarning();
                }, INACTIVITY_TIME);
            }

            function showInactivityWarning() {
                document.getElementById('inactivityModal').style.display = 'block';
                countdownSeconds = 120;
                updateCountdown();
                countdownTimer = setInterval(updateCountdown, 1000);
                warningTimer = setTimeout(() => {
                    performLogout(true); 
                }, WARNING_TIME);
            }

            function updateCountdown() {
                const minutes = Math.floor(countdownSeconds / 60);
                const seconds = countdownSeconds % 60;
                const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('countdown').textContent = display;
                
                if (countdownSeconds <= 0) {
                    performLogout(true);
                    return;
                }
                countdownSeconds--;
            }

            function extendSession() {
                document.getElementById('inactivityModal').style.display = 'none';
                clearTimeout(warningTimer);
                clearInterval(countdownTimer);
                resetInactivityTimer();
            }

            function setupActivityListeners() {
                activityEvents.forEach(event => {
                    document.addEventListener(event, resetInactivityTimer, true);
                });
            }

            async function logout() {
                if (isLoggingOut) return;
                
                const confirmLogout = confirm('¿Estás seguro de que deseas cerrar sesión?');
                if (confirmLogout) {
                    await performLogout();
                }
            }

            async function performLogout(isAutomatic = false) {
                if (isLoggingOut) return;
                
                isLoggingOut = true;
                
                clearTimeout(inactivityTimer);
                clearTimeout(warningTimer);
                clearInterval(countdownTimer);
                
                activityEvents.forEach(event => {
                    document.removeEventListener(event, resetInactivityTimer, true);
                });

                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.style.pointerEvents = 'none';
                    logoutBtn.textContent = isAutomatic ? 'Sesión expirada...' : 'Cerrando sesión...';
                }
                
                if (typeof(Storage) !== "undefined") {
                    const token = localStorage.getItem('access_token');
                    
                    if (token) {
                        try {
                            const response = await fetch('/logout', {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                        } catch (error) {
                            console.error('Error during logout:', error);
                        }
                    }
                    
                    localStorage.clear();
                    sessionStorage.clear();
                }

                if (isAutomatic) {
                    alert('Tu sesión ha expirado por inactividad. Serás redirigido al login.');
                }
                
                setTimeout(() => {
                    window.location.replace('/login');
                }, 1000);
            }

            window.addEventListener('load', async function() {
                if (!checkAuthentication()) {
                    setTimeout(() => {
                        window.location.replace('/login');
                    }, 3000);
                    return;
                }
                
                try {
                    const response = await makeAuthenticatedRequest('/verify-auth');
                    
                    if (response.ok) {
                        const userData = await response.json();
                        updateUserInfo(userData);
                        setupActivityListeners();
                        resetInactivityTimer();
                        return;
                    }
                } catch (error) {
                    console.warn('verify-auth failed:', error);
                }
                
                try {
                    const response = await makeAuthenticatedRequest('/dashboard');
                    
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        
                        if (contentType && contentType.includes('application/json')) {
                            const userData = await response.json();
                            updateUserInfo(userData);
                            setupActivityListeners();
                            resetInactivityTimer();
                            return;
                        }
                    }
                } catch (error) {
                    console.warn('dashboard request failed:', error);
                }
                
                setTimeout(() => {
                    window.location.replace('/login');
                }, 5000);
            });

            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    window.location.reload();
                }
            });

            window.addEventListener('popstate', function(event) {
                if (!isLoggingOut) {
                    const currentPath = window.location.pathname;
                    
                    if (currentPath === '/login' || currentPath === '/' || !currentPath.startsWith('/dashboard')) {
                        localStorage.clear();
                        sessionStorage.clear();
                        window.location.replace('/login');
                    }
                }
            });

            window.addEventListener('beforeunload', function(event) {
                if (!isLoggingOut) {
                    const destination = event.target.activeElement;
                    
                    if (destination && destination.tagName === 'A') {
                        const href = destination.href;
                        if (href && (href.includes('/register') || href.includes('/users') || href.includes('/departments'))) {
                            return; 
                        }
                    }
                    
                    event.preventDefault();
                    return event.returnValue = '¿Estás seguro de que deseas salir?';
                }
            });

            window.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modal = document.getElementById('inactivityModal');
                    if (modal.style.display === 'block') {
                        extendSession();
                    }
                }
            });
        </script>
    </body>
</html>